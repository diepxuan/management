#!/usr/bin/env bash
#!/bin/bash

_MYSQL_REPLICATE=""
_MYSQL_REPLICATE_TOOGLE=""
_MYSQL_REPLICATE_TOOGLE=""
_MYSQL_REPLICATE_HOST=0

_DEBUG=0
_BASEDIR="/var/www/base"
_BASHDIR="$_BASEDIR/bash"

. $_BASHDIR/ssl
. $_BASHDIR/sys
. $_BASHDIR/vpn/pptp
. $_BASHDIR/httpd
. $_BASHDIR/log
. $_BASHDIR/mssql_php

--swap() {
    $_BASHDIR/ductn_swap $@
}

--mysql:ssl:enable() {
    $_BASHDIR/ductn_mysql ssl:enable
}

mysql-galera() {
    $_BASHDIR/ductn mysql galera $@
}

--aliases() {
    $_BASEDIR/bash/ductn_init aliases
}

aliases() {
    --aliases $@
}

--composer() {
    $_BASEDIR/bash/ductn_composer $@
}

--wslcli() {
    --install() {
        if grep -q Microsoft /proc/version; then
            mkdir -p /mnt/c/wslcli/
            cat /var/www/base/bash/win10/php.bat >/mnt/c/wslcli/php.bat
            cat /var/www/base/bash/win10/yarn.bat >/mnt/c/wslcli/yarn.bat
            cat /var/www/base/bash/win10/phpcs.bat >/mnt/c/wslcli/phpcs.bat
        fi
    }

    -i() {
        --install
    }

    $@
}

--dns() {
    $_BASHDIR/ductn_dns $@
}

--gitconfig() {

    $_BASHDIR/ductn_git $@

    # git config http.postBuffer 524288000
    # git config receive.denyCurrentBranch refuse

}

--git() {
    --gitconfig $@
}

--ssh() {
    $_BASEDIR/bash/ductn_ssh $@
}

--ssh:install() {
    $_BASEDIR/bash/ductn_ssh --install
}

--user:new() {
    $_BASHDIR/ductn_user new $@
}

--hosts() {
    $_BASHDIR/ductn_hosts $@
}

--mysql-cluster() {
    --install() {
        # ductn_hosts add 35.229.247.242  server.diepxuan.com
        # ductn_hosts add 35.232.100.140  server2.diepxuan.com
        # ductn_hosts add 103.56.156.159  server3.diepxuan.com
        # wget https://repo.mysql.com//mysql-apt-config_0.8.15-1_all.deb -O mysql-apt-config.deb
        # sudo dpkg -i mysql-apt-config.deb
        # rm -rf mysql-apt-config.deb

        cd "$_BASHDIR"

        _exec() {
            echo "dx$@.diepxuan.com"
            ssh dx$@.diepxuan.com "
                sudo mkdir -p /var/lib/mysql-cluster/
                echo \"net.ipv4.ip_forward = 1\"        | sudo tee /etc/sysctl.d/999-mysql-cluster.conf
                echo \"net.ipv4.ip_nonlocal_bind = 1\"  | sudo tee -a /etc/sysctl.d/999-mysql-cluster.conf
                sudo sysctl -f /etc/sysctl.d/999-mysql-cluster.conf
            "
            cat mysql_cluster/mysql-cluster.config.ini | ssh dx$@.diepxuan.com "sudo tee /var/lib/mysql-cluster/config.ini"
            cat mysql_cluster/mysqld.cnf | ssh dx$@.diepxuan.com "sudo tee /etc/mysql/conf.d/mysqld_cluster.cnf"
            cat mysql_cluster/dx$@.mysqld.cnf | ssh dx$@.diepxuan.com "sudo tee -a /etc/mysql/conf.d/mysqld_cluster.cnf"
            cat mysql_cluster/ndb_mgmd.service | ssh dx$@.diepxuan.com "sudo tee /etc/systemd/system/ndb_mgmd.service"
            cat mysql_cluster/ndbd.service | ssh dx$@.diepxuan.com "sudo tee /etc/systemd/system/ndbd.service"
            ssh dx$@.diepxuan.com "
                sudo systemctl daemon-reload
                # sudo systemctl enable ndb_mgmd
                # sudo systemctl restart ndb_mgmd
                # sudo service ndb_mgmd restart
                # sudo service ndbd restart
                # sudo service mysql restart
            "
        }

        _exec 3
        _exec 2
        _exec 1
    }

    --remove() {
        _exec() {
            ssh dx$@.diepxuan.com "
                sudo systemctl stop ndb_mgmd
                sudo systemctl disable ndb_mgmd
                sudo systemctl stop ndbd
                sudo systemctl disable ndbd

                sudo rm -rf /var/lib/mysql-cluster/config.ini
                sudo rm -rf /etc/mysql/conf.d/mysqld_cluster.cnf
                sudo rm -rf /etc/systemd/system/ndb_mgmd.service
                sudo rm -rf /etc/systemd/system/ndbd.service
                sudo rm -rf /var/lib/mysql-cluster

                sudo apt remove mysql-apt-config mysql-cluster-community-management-server -y --purge --auto-remove
                sudo apt update
                sudo apt dist-upgrade -y --purge --auto-remove
            "
        }

        _exec 3
        _exec 2
        _exec 1
    }

    $@
}

--ddns:update() {
    $_BASHDIR/ductn_ddns update
}

--cronjob() {
    $_BASHDIR/ductn_cronjob $@
}

--cron:service() {
    --cronjob service
}

--cron:update() {
    --ddns:update
}

--cron:--service() {
    --cronjob service
}

--cron:--update() {
    --ddns:update
}

--cron() {
    --cron:$@
}

--apt:fix() {
    #!/bin/bash

    sudo killall apt-get
    sudo killall apt

    sudo rm /var/lib/apt/lists/lock
    sudo rm /var/cache/apt/archives/lock
    sudo rm /var/lib/dpkg/lock
    sudo rm /var/lib/dpkg/lock-frontend

    sudo dpkg --configure -a
}

--sys:init() {
    $_BASHDIR/ductn_init
}

--mysql-replicate() {
    _MYSQL_REPLICATE="on"

    while [ $# -gt 0 ]; do
        case $1 in
        -i | --install) _MYSQL_REPLICATE_TOOGLE="on" ;;
        --remove) _MYSQL_REPLICATE_TOOGLE="off" ;;
        --host=?* | -h=?*) _MYSQL_REPLICATE_HOST=${1#*=} ;;
        --host | -h)
            _MYSQL_REPLICATE_HOST=$2
            shift
            ;;
        --host=)
            die 'ERROR: "--host" requires a non-empty option argument.'
            ;;
        --) break ;;
        -?*) printf 'WARN: Unknown option (ignored): %s\n' "$1" >&2 ;;
        *) break ;;
        esac

        shift
    done

}

--pull() {
    cd "$_BASEDIR"
    git fetch -ap
    git reset --hard origin/master
}

--selfupdate() {
    $_BASHDIR/ductn pull
    $_BASHDIR/ductn init
}

--self-update() {
    --selfupdate
}

# $@
"--$@"

cd "$_BASEDIR"

F_mysql_replicate() {

    --install() {
        # ductn_hosts add 35.229.247.242  server.diepxuan.com
        # ductn_hosts add 35.232.100.140  server2.diepxuan.com
        # ductn_hosts add 103.56.156.159  server3.diepxuan.com
        # wget https://repo.mysql.com//mysql-apt-config_0.8.15-1_all.deb -O mysql-apt-config.deb
        # sudo dpkg -i mysql-apt-config.deb
        # rm -rf mysql-apt-config.deb

        cd "$_BASHDIR"

        sudo mkdir -p /var/lib/mysql-cluster/

        cat $_BASHDIR/mysql_replicate/mysqld.cnf | sudo tee /etc/mysql/conf.d/mysqld_cluster.cnf
        cat $_NASHDIR/mysql_replicate/dx$@.mysqld.cnf | sudo tee -a /etc/mysql/conf.d/mysqld_cluster.cnf

        sudo service mysql restart

        sudo mysql <mysql_replicate/replicate.sql

    }

    --remove() {
        sudo rm -rf /etc/mysql/conf.d/mysqld_cluster.cnf
        sudo mysql <mysql_replicate/remove.sql
        sudo service mysql restart
    }

    $@
}

if [[ $_MYSQL_REPLICATE = "on" ]]; then
    # echo "_MYSQL_REPLICATE = $_MYSQL_REPLICATE"
    if [[ $_MYSQL_REPLICATE_TOOGLE = "on" ]]; then
        # echo "_MYSQL_REPLICATE_TOOGLE = $_MYSQL_REPLICATE_TOOGLE"
        # echo "_MYSQL_REPLICATE_HOST = $_MYSQL_REPLICATE_HOST"
        F_mysql_replicate --install $_MYSQL_REPLICATE_HOST
    else
        F_mysql_replicate --remove
    fi
fi

exit 0
