#!/usr/bin/env bash
#!/bin/bash

install(){
    cronjob(){
        chmod u+x /var/www/base/bash/cronjob/*.sh
        chmod u+x /var/www/base/bash/cronjob/cronjob
        sudo crontab /var/www/base/bash/cronjob/cronjob.conf
        sudo service cron restart
    }

    mysql_cluster(){
        # ductn_hosts add 35.229.247.242  server.diepxuan.com
        # ductn_hosts add 35.232.100.140  server2.diepxuan.com
        # ductn_hosts add 103.56.156.159  server3.diepxuan.com
        # wget https://repo.mysql.com//mysql-apt-config_0.8.15-1_all.deb -O mysql-apt-config.deb
        # sudo dpkg -i mysql-apt-config.deb
        # rm -rf mysql-apt-config.deb

        cd "$(dirname "$0")"

        add(){
            cat mysql_cluster/mysql-cluster.config.ini  | ssh dx$@.diepxuan.com "sudo tee /var/lib/mysql-cluster/config.ini"
            cat mysql_cluster/mysqld.cnf                | ssh dx$@.diepxuan.com "sudo tee /etc/mysql/mysql.conf.d/mysqld_cluster.cnf"
            cat mysql_cluster/dx$@.mysqld.cnf           | ssh dx$@.diepxuan.com "sudo tee -a /etc/mysql/mysql.conf.d/mysqld_cluster.cnf"
            cat mysql_cluster/ndb_mgmd.service          | ssh dx$@.diepxuan.com "sudo tee /etc/systemd/system/ndb_mgmd.service"
            cat mysql_cluster/ndbd.service              | ssh dx$@.diepxuan.com "sudo tee /etc/systemd/system/ndbd.service"
            ssh dx$@.diepxuan.com "
                sudo systemctl daemon-reload
                # sudo systemctl enable ndb_mgmd
                # sudo systemctl restart ndb_mgmd
                # sudo service ndb_mgmd restart
                # sudo service ndbd restart
                # sudo service mysql restart
            "
        }

        add 3
        add 1
    }

    git(){
        cat /var/www/base/bash/git/.gitignore >~/.gitignore
        chmod 644 ~/.gitignore

        # global gitignore
        git config --global core.excludesfile ~/.gitignore

        # setting
        git config --global user.name "Tran Ngoc Duc"
        git config --global user.email "caothu91@gmail.com"

        # alias
        git config --global alias.plog "log --graph --pretty=format:'%h -%d %s %n' --abbrev-commit --date=relative --branches"

        # push
        git config --global push.default simple

        # file mode
        git config --global core.fileMode false

        # line endings
        git config --global core.autocrlf false
        git config --global core.eol lf

        # Cleanup
        git config --global gc.auto 0

        # remote server
        git config --global receive.denyCurrentBranch updateInstead


        # remote repository
        cat /var/www/base/bash/git/push-to-checkout > .git/hooks/push-to-checkout
        chmod +x .git/hooks/push-to-checkout

        rm .git/hooks/post-receive
        if [[ $1 = "server" ]]; then
            cat /var/www/base/bash/git/post-receive > .git/hooks/post-receive
        fi

        chmod +x .git/hooks/*

        # git config http.postBuffer 524288000
        # git config receive.denyCurrentBranch refuse
    }

    dns(){
        #!/bin/bash
        cd "$(dirname "$0")"

        # sudo apt install bind9 bind9utils bind9-doc dnsutils -y

        cat dns/slave.conf.options  | ssh dx1.diepxuan.com "sudo tee /etc/bind/named.conf.options"
        cat dns/slave.conf.local    | ssh dx1.diepxuan.com "sudo tee /etc/bind/named.conf.local"
        scp dns/db.* ductn@dx1.diepxuan.com
        ssh dx1.diepxuan.com "
            mkdir /etc/bind/zones
            sudo mv db.* /etc/bind/zones
            sudo service bind9 restart
        "

        cat dns/master.conf.options | ssh dx3.diepxuan.com "sudo tee /etc/bind/named.conf.options"
        cat dns/master.conf.local   | ssh dx3.diepxuan.com "sudo tee /etc/bind/named.conf.local"
        scp dns/db.* ductn@dx3.diepxuan.com:~/
        ssh dx3.diepxuan.com "
            mkdir -p /etc/bind/zones
            sudo mv ~/db.* /etc/bind/zones
            sudo service bind9 restart
        "
        # sudo apt install stunnel4 -y --purge --auto-remove
        # cat /var/www/base/bash/dns/stunnel.conf | sudo tee /etc/stunnel/stunnel.conf
        # sudo service bind9 restart
    }

    httpd(){
        #!/usr/bin/env bash

        # CREATE ductn SITE
        ###################
        #shellcheck disable=SC2002
        cat /var/www/base/httpd/httpd.conf | sudo tee /etc/apache2/sites-available/ductn.conf
        printf "\n\n" >>/etc/apache2/sites-available/ductn.conf
        find /var/www/base/httpd/*/httpd.conf -type f -exec cat {} \; | sudo tee -a /etc/apache2/sites-available/ductn.conf

        # CREATE Dav Access
        ###################
        # mkdir -p /var/www/DavLock
        sudo mkdir -p /home/cloud/public_html/cloud
        sudo chmod -R 777 /home/cloud/public_html/cloud
        sudo a2enmod dav dav_fs auth_digest &>/dev/null

        # APPLY APACHE CONFIG
        #####################
        sudo a2ensite ductn.conf
        sudo a2dismod mpm_prefork mpm_worker mpm_event
        sudo a2enmod proxy proxy_http headers deflate expires rewrite mcrypt reqtimeout vhost_alias ssl env dir mime &>/dev/null
        # sudo a2dismod php?.?
        # sudo a2enmod php7.1

        sudo apache2ctl configtest
        sudo service apache2 restart
        # sudo service apache2 status

        #  rm -rf /var/www/html/live/pma.diepxuan.vn/config.inc.php
        #  ln /var/www/base/tool/php/phpmyadmin/config.inc.php /var/www/html/live/pma.diepxuan.vn/

    }

    ssl(){

        #!/bin/bash

        --install() {
          sudo apt install software-properties-common -y --purge --auto-remove
          # sudo add-apt-repository universe
          # sudo add-apt-repository ppa:certbot/certbot
          sudo apt update
          sudo apt install -y --purge --auto-remove python3-pip
          sudo pip3 install certbot certbot-dns-cloudflare
        }
        
        --setup(){
        
	        #sudo certbot certonly --apache \
	        #  --expand \
	        #  --no-redirect \
	        #  --keep-until-expiring \
	        #  --break-my-certs \
	        #  --pre-hook /var/www/base/bash/certbot/authenticator.sh \
	        #  -m caothu91@gmail.com \
	        #  --server https://acme-v02.api.letsencrypt.org/directory
	
	        _certbot() {
	
	          chmod 600 /var/www/base/bash/certbot/cloudflare.ini
	
	          sudo certbot certonly \
	            --expand \
	            --keep-until-expiring \
	            --dns-cloudflare \
	            --dns-cloudflare-credentials /var/www/base/bash/certbot/cloudflare.ini \
	            --agree-tos \
	            --email caothu91@gmail.com \
	            --eff-email \
	            -d $1
	        }
	
	        #_certbot solzatech.com,www.solzatech.com
	        _certbot diepxuan.com,www.diepxuan.com,luong.diepxuan.com,pma.diepxuan.com,cloud.diepxuan.com
	
	        sudo service apache2 restart
	
	        #  sudo cat /etc/letsencrypt/live/mail.diepxuan.com/fullchain.pem | ssh server3.diepxuan.com "sudo tee /etc/letsencrypt/live/mail.diepxuan.com/fullchain.pem"
	        #  sudo cat /etc/letsencrypt/live/mail.diepxuan.com/privkey.pem | ssh server3.diepxuan.com "sudo tee /etc/letsencrypt/live/mail.diepxuan.com/privkey.pem"
	
	        sudo cat /etc/letsencrypt/live/diepxuan.com/cert.pem | ssh dx3.diepxuan.com "sudo tee /etc/letsencrypt/live/diepxuan.com/cert.pem"
	        sudo cat /etc/letsencrypt/live/diepxuan.com/chain.pem | ssh dx3.diepxuan.com "sudo tee /etc/letsencrypt/live/diepxuan.com/chain.pem"
	        sudo cat /etc/letsencrypt/live/diepxuan.com/fullchain.pem | ssh dx3.diepxuan.com "sudo tee /etc/letsencrypt/live/diepxuan.com/fullchain.pem"
	        sudo cat /etc/letsencrypt/live/diepxuan.com/privkey.pem | ssh dx3.diepxuan.com "sudo tee /etc/letsencrypt/live/diepxuan.com/privkey.pem"
	
	        # sudo scp -r /etc/letsencrypt/live/* dx3.diepxuan.com:/etc/letsencrypt/live/
        }

        $@
		--setup

    }

    $@
}

remove(){
    mysql_cluster(){

        _exec(){
            ssh dx$@.diepxuan.com "
                sudo systemctl stop ndb_mgmd
                sudo systemctl disable ndb_mgmd
                sudo systemctl stop ndbd
                sudo systemctl disable ndbd

                sudo rm -rf /var/lib/mysql-cluster/config.ini
                sudo rm -rf /etc/mysql/mysql.conf.d/mysqld_cluster.cnf
                sudo rm -rf /etc/systemd/system/ndb_mgmd.service
                sudo rm -rf /etc/systemd/system/ndbd.service
                sudo rm -rf /var/lib/mysql-cluster

                sudo apt remove mysql-apt-config mysql-cluster-community-management-server -y --purge --auto-remove
                sudo apt update
                sudo apt dist-upgrade -y --purge --auto-remove
            "
        }

        _exec 3
        _exec 1
    }

    $@
}

log(){
    ssh dx3.diepxuan.com "sudo tail -f /var/log/syslog" & ssh dx1.diepxuan.com "sudo tail -f /var/log/syslog"
}

update(){

    allowip(){

        allowdomain(){
            getip(){
                echo "$(host $@ | cut -f4 -d' ')"
            }
            local Current_IP="$(getip $@)"
            sudo ufw allow from ${Current_IP} to any
            # echo "${Current_IP}"
        }

        allowdomain dxvnkthd.ddns.net
        allowdomain dxvnk113.ddns.net
        allowdomain dxvnkkcn.ddns.net
        allowdomain mg15vincom.ddns.net
    }

    $@

}

fix(){
    #!/bin/bash

    apt(){
        sudo killall apt-get
        sudo killall apt

        sudo rm /var/lib/apt/lists/lock
        sudo rm /var/cache/apt/archives/lock
        sudo rm /var/lib/dpkg/lock
        sudo rm /var/lib/dpkg/lock-frontend

        sudo dpkg --configure -a
    }

    $@
}

$@
